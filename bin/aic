#!/bin/bash

# Gemini APIë¥¼ ì‚¬ìš©í•œ AI ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±ê¸° (ìµœì¢… ë²„ì „)

# ì„¤ì • íŒŒì¼ ìœ„ì¹˜
CONFIG_FILE="$HOME/.gemini-commit-config.json"

# ì„¤ì • íŒŒì¼ ì½ê¸° í•¨ìˆ˜
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        LANGUAGE=$(cat "$CONFIG_FILE" | grep -o '"language":"[^"]*"' | cut -d'"' -f4)
        [ -z "$LANGUAGE" ] && LANGUAGE="ko"
    else
        LANGUAGE=""
    fi
}

# ì„¤ì • íŒŒì¼ ì €ì¥ í•¨ìˆ˜
save_config() {
    local lang=$1
    mkdir -p "$(dirname "$CONFIG_FILE")"
    echo '{"language":"'$lang'"}' > "$CONFIG_FILE"
}

# ì–¸ì–´ë³„ ë©”ì‹œì§€ í•¨ìˆ˜
msg() {
    local key=$1
    case "$LANGUAGE" in
        "en")
            case "$key" in
                "welcome") echo "ğŸ¤– AI Commit CLI - AI-powered commit message generator" ;;
                "setup_progress") echo "ğŸ”§ Setting up Git alias..." ;;
                "setup_success") echo "âœ… Git alias has been successfully set up!" ;;
                "setup_available") echo "Now you can use these commands:" ;;
                "setup_failed") echo "âŒ Failed to set up Git alias." ;;
                "unsetup_progress") echo "ğŸ”§ Removing Git alias..." ;;
                "unsetup_success") echo "âœ… Git alias has been successfully removed!" ;;
                "unsetup_available") echo "Now you can only use these commands:" ;;
                "unsetup_help") echo "ğŸ’¡ To use git ai-commit again:" ;;
                "unsetup_failed") echo "âŒ Failed to remove Git alias." ;;
                "unsetup_not_found") echo "ğŸ’¡ Alias may not be set up." ;;
                "help_usage") echo "Usage:" ;;
                "help_staged") echo "  aic                     # Generate AI commit message for staged files" ;;
                "help_all") echo "  aic --all               # Stage all files and generate AI commit message" ;;
                "help_options") echo "Options:" ;;
                "help_all_desc") echo "  --all, -a               # Stage all files" ;;
                "help_configure_desc") echo "  --configure             # Configure language settings" ;;
                "help_setup_desc") echo "  --setup                 # Set up git alias" ;;
                "help_unsetup_desc") echo "  --unsetup               # Remove git alias" ;;
                "help_help_desc") echo "  --help, -h              # Show help" ;;
                "help_settings") echo "Settings:" ;;
                "help_example") echo "Examples:" ;;
                "help_example_staged") echo "  aic                     # Commit staged files only" ;;
                "help_example_all") echo "  aic --all               # Stage all files and commit" ;;
                "help_short_cmd") echo "  aic                     # Short command" ;;
                "help_git_alias") echo "  git aic                 # Git alias (setup required)" ;;
                "help_setup_cmd") echo "  aic --setup             # Enable git aic command" ;;
                "help_unsetup_cmd") echo "  aic --unsetup           # Disable git aic command" ;;
                "help_configure_cmd") echo "  aic --configure         # Change language settings" ;;
                "unknown_option") echo "âŒ Unknown option:" ;;
                "usage_help") echo "Usage: aic [--all|-a] [--configure] [--setup|--unsetup] [--help|-h]" ;;
                "not_git_repo") echo "âŒ Not a Git repository." ;;
                "staging_all") echo "ğŸ“¦ Staging all files..." ;;
                "gemini_not_installed") echo "âš ï¸  Gemini CLI is not installed or not authenticated. Please follow these steps:
   1. Install: npm install -g @google/gemini-cli
   2. Authenticate: gemini (follow the authentication prompts)" ;;
                "fallback_editor") echo "ğŸ”§ Using standard editor for commit message..." ;;
                "editor_prompt") echo "Do you want to write a commit message in the text editor? (y/n): " ;;
                "editor_cancelled") echo "ğŸš« Cancelled." ;;
                "editor_invalid") echo "Please enter y or n." ;;
                "no_staged_files") echo "âš ï¸  No staged files found." ;;
                "choose_action") echo "ğŸ’¡ Choose one of the following:" ;;
                "action_1") echo "  1. ${BOLD}git add <filename>${NC} to stage specific files" ;;
                "action_2") echo "  2. ${BOLD}git add .${NC} to stage all files" ;;
                "action_3") echo "  3. ${BOLD}aic --all${NC} to auto-stage all files" ;;
                "unstaged_files") echo "ğŸ“Š Unstaged files:" ;;
                "no_changes") echo "ğŸ“Š No changes found." ;;
                "analyzing_staged") echo "ğŸ“ Analyzing staged file changes..." ;;
                "ai_generating") echo "ğŸ¤– AI is generating commit message..." ;;
                "ai_generated") echo "ğŸ¯ AI Generated Commit Message:" ;;
                "ai_no_response") echo "âš ï¸  No AI response received." ;;
                "change_summary") echo "ğŸ“Š Change Summary:" ;;
                "new_files") echo "  + $1 new files" ;;
                "modified_files") echo "  ~ $1 modified files" ;;
                "deleted_files") echo "  - $1 deleted files" ;;
                "commit_prompt") echo "Use this commit message? (y)es/(n)o/(e)dit/(c)ustom:" ;;
                "commit_success") echo "âœ… Commit created successfully!" ;;
                "commit_message") echo "ğŸ“ Commit message:" ;;
                "commit_info") echo "ğŸ“‹ Commit info:" ;;
                "commit_failed") echo "âŒ Failed to create commit." ;;
                "commit_cancelled") echo "ğŸš« Commit cancelled." ;;
                "editor_starting") echo "âœï¸  Starting editor..." ;;
                "edit_success") echo "âœ… Edited commit created successfully!" ;;
                "edit_cancelled") echo "ğŸš« Edit cancelled." ;;
                "custom_message") echo "âœï¸  Enter custom commit message:" ;;
                "custom_success") echo "âœ… Custom commit created successfully!" ;;
                "empty_message") echo "âš ï¸  Commit message is empty." ;;
                "invalid_choice") echo "âŒ Please enter y, n, e, or c." ;;
                "configure_title") echo "ğŸŒ Language Configuration" ;;
                "configure_current") echo "ğŸ“ Current language: $1" ;;
                "configure_select") echo "ğŸ”¤ Select language / ì–¸ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”:" ;;
                "configure_korean") echo "  1. í•œêµ­ì–´ (Korean)" ;;
                "configure_english") echo "  2. English" ;;
                "configure_prompt") echo "Enter choice (1-2): " ;;
                "configure_success") echo "âœ… Language set to: $1" ;;
                "configure_invalid") echo "âŒ Invalid choice. Please select 1 or 2." ;;
                "first_run_title") echo "ğŸ‰ Welcome to AI Commit Assistant!" ;;
                "first_run_subtitle") echo "First-time setup" ;;
                "first_run_desc") echo "Please select your preferred language for UI and commit messages:" ;;
                *) echo "$key" ;;
            esac
            ;;
        *)
            case "$key" in
                "welcome") echo "ğŸ¤– AI Commit CLI - AI ê¸°ë°˜ ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±ê¸°" ;;
                "setup_progress") echo "ğŸ”§ Git alias ì„¤ì • ì¤‘..." ;;
                "setup_success") echo "âœ… Git aliasê°€ ì„±ê³µì ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!" ;;
                "setup_available") echo "ì´ì œ ë‹¤ìŒ ëª…ë ¹ì–´ë“¤ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:" ;;
                "setup_failed") echo "âŒ Git alias ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." ;;
                "unsetup_progress") echo "ğŸ”§ Git alias í•´ì œ ì¤‘..." ;;
                "unsetup_success") echo "âœ… Git aliasê°€ ì„±ê³µì ìœ¼ë¡œ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤!" ;;
                "unsetup_available") echo "ì´ì œ ë‹¤ìŒ ëª…ë ¹ì–´ë“¤ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:" ;;
                "unsetup_help") echo "ğŸ’¡ git aic ëª…ë ¹ì–´ë¥¼ ë‹¤ì‹œ ì‚¬ìš©í•˜ë ¤ë©´:" ;;
                "unsetup_failed") echo "âŒ Git alias í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." ;;
                "unsetup_not_found") echo "ğŸ’¡ aliasê°€ ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤." ;;
                "help_usage") echo "ì‚¬ìš©ë²•:" ;;
                "help_staged") echo "  aic                     # staged íŒŒì¼ë¡œ AI ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±" ;;
                "help_all") echo "  aic --all               # ëª¨ë“  íŒŒì¼ì„ staging í›„ AI ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±" ;;
                "help_options") echo "ì˜µì…˜:" ;;
                "help_all_desc") echo "  --all, -a               # ëª¨ë“  íŒŒì¼ì„ stagingì— ì¶”ê°€" ;;
                "help_configure_desc") echo "  --configure             # ì–¸ì–´ ì„¤ì • ë³€ê²½" ;;
                "help_setup_desc") echo "  --setup                 # git alias ì„¤ì •" ;;
                "help_unsetup_desc") echo "  --unsetup               # git alias í•´ì œ" ;;
                "help_help_desc") echo "  --help, -h              # ë„ì›€ë§ í‘œì‹œ" ;;
                "help_settings") echo "ì„¤ì •:" ;;
                "help_example") echo "ì˜ˆì‹œ:" ;;
                "help_example_staged") echo "  aic                     # staged íŒŒì¼ë§Œ ì»¤ë°‹" ;;
                "help_example_all") echo "  aic --all               # ëª¨ë“  íŒŒì¼ì„ staging í›„ ì»¤ë°‹" ;;
                "help_short_cmd") echo "  aic                     # ì¶•ì•½ ëª…ë ¹ì–´" ;;
                "help_git_alias") echo "  git aic                 # git alias (ì„¤ì • í•„ìš”)" ;;
                "help_setup_cmd") echo "  aic --setup             # git aic ëª…ë ¹ì–´ í™œì„±í™”" ;;
                "help_unsetup_cmd") echo "  aic --unsetup           # git aic ëª…ë ¹ì–´ í•´ì œ" ;;
                "help_configure_cmd") echo "  aic --configure         # ì–¸ì–´ ì„¤ì • ë³€ê²½" ;;
                "unknown_option") echo "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì˜µì…˜:" ;;
                "usage_help") echo "ì‚¬ìš©ë²•: aic [--all|-a] [--configure] [--setup|--unsetup] [--help|-h]" ;;
                "not_git_repo") echo "âŒ Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤." ;;
                "staging_all") echo "ğŸ“¦ ëª¨ë“  íŒŒì¼ì„ stagingí•©ë‹ˆë‹¤..." ;;
                "gemini_not_installed") echo "âš ï¸  Gemini CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šê±°ë‚˜ ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¼ì£¼ì„¸ìš”:
   1. ì„¤ì¹˜: npm install -g @google/gemini-cli
   2. ì¸ì¦: gemini (ì¸ì¦ ê³¼ì •ì„ ë”°ë¼ ì™„ë£Œí•˜ì„¸ìš”)" ;;
                "fallback_editor") echo "ğŸ”§ ì¼ë°˜ ì—ë””í„°ë¡œ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤..." ;;
                "editor_prompt") echo "í…ìŠ¤íŠ¸ ì—ë””í„°ì—ì„œ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ë‚¨ê¸°ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): " ;;
                "editor_cancelled") echo "ğŸš« ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤." ;;
                "editor_invalid") echo "y ë˜ëŠ” nì„ ì…ë ¥í•´ì£¼ì„¸ìš”." ;;
                "no_staged_files") echo "âš ï¸  stagingëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤." ;;
                "choose_action") echo "ğŸ’¡ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”:" ;;
                "action_1") echo "  1. ${BOLD}git add <íŒŒì¼ëª…>${NC} ìœ¼ë¡œ íŠ¹ì • íŒŒì¼ì„ staging" ;;
                "action_2") echo "  2. ${BOLD}git add .${NC} ìœ¼ë¡œ ëª¨ë“  íŒŒì¼ì„ staging" ;;
                "action_3") echo "  3. ${BOLD}aic --all${NC} ìœ¼ë¡œ ëª¨ë“  íŒŒì¼ì„ ìë™ staging" ;;
                "unstaged_files") echo "ğŸ“Š unstaged íŒŒì¼ ëª©ë¡:" ;;
                "no_changes") echo "ğŸ“Š ë³€ê²½ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤." ;;
                "analyzing_staged") echo "ğŸ“ Staged íŒŒì¼ì˜ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•©ë‹ˆë‹¤..." ;;
                "ai_generating") echo "ğŸ¤– AIê°€ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..." ;;
                "ai_generated") echo "ğŸ¯ AI ìƒì„± ì»¤ë°‹ ë©”ì‹œì§€:" ;;
                "ai_no_response") echo "âš ï¸  AI ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤." ;;
                "change_summary") echo "ğŸ“Š ë³€ê²½ì‚¬í•­ ìš”ì•½:" ;;
                "new_files") echo "  + $1 ìƒˆ íŒŒì¼" ;;
                "modified_files") echo "  ~ $1 ìˆ˜ì •ëœ íŒŒì¼" ;;
                "deleted_files") echo "  - $1 ì‚­ì œëœ íŒŒì¼" ;;
                "commit_prompt") echo "ì´ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y)es/(n)o/(e)dit/(c)ustom:" ;;
                "commit_success") echo "âœ… ì»¤ë°‹ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!" ;;
                "commit_message") echo "ğŸ“ ì»¤ë°‹ ë©”ì‹œì§€:" ;;
                "commit_info") echo "ğŸ“‹ ì»¤ë°‹ ì •ë³´:" ;;
                "commit_failed") echo "âŒ ì»¤ë°‹ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." ;;
                "commit_cancelled") echo "ğŸš« ì»¤ë°‹ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤." ;;
                "editor_starting") echo "âœï¸  ì—ë””í„°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..." ;;
                "edit_success") echo "âœ… í¸ì§‘ëœ ì»¤ë°‹ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!" ;;
                "edit_cancelled") echo "ğŸš« í¸ì§‘ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤." ;;
                "custom_message") echo "âœï¸  ì»¤ìŠ¤í…€ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”:" ;;
                "custom_success") echo "âœ… ì»¤ìŠ¤í…€ ì»¤ë°‹ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!" ;;
                "empty_message") echo "âš ï¸  ì»¤ë°‹ ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤." ;;
                "invalid_choice") echo "âŒ y, n, e, ë˜ëŠ” cë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." ;;
                "configure_title") echo "ğŸŒ ì–¸ì–´ ì„¤ì •" ;;
                "configure_current") echo "ğŸ“ í˜„ì¬ ì–¸ì–´: $1" ;;
                "configure_select") echo "ğŸ”¤ ì–¸ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš” / Select language:" ;;
                "configure_korean") echo "  1. í•œêµ­ì–´ (Korean)" ;;
                "configure_english") echo "  2. English" ;;
                "configure_prompt") echo "ì„ íƒí•˜ì„¸ìš” (1-2): " ;;
                "configure_success") echo "âœ… ì–¸ì–´ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: $1" ;;
                "configure_invalid") echo "âŒ ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤. 1 ë˜ëŠ” 2ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”." ;;
                "first_run_title") echo "ğŸ‰ AI Commit Assistantì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!" ;;
                "first_run_subtitle") echo "ìµœì´ˆ ì„¤ì •" ;;
                "first_run_desc") echo "UIì™€ ì»¤ë°‹ ë©”ì‹œì§€ì— ì‚¬ìš©í•  ì–¸ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”:" ;;
                *) echo "$key" ;;
            esac
            ;;
    esac
}

# ì–¸ì–´ ì„¤ì • í•¨ìˆ˜
configure_language() {
    echo -e "${BLUE}============================================================${NC}"
    echo -e "${BOLD}$(msg "configure_title")${NC}"
    echo -e "${BLUE}============================================================${NC}"
    echo ""
    
    if [ -n "$LANGUAGE" ]; then
        local current_lang_name
        if [ "$LANGUAGE" = "en" ]; then
            current_lang_name="English"
        else
            current_lang_name="í•œêµ­ì–´"
        fi
        echo -e "${CYAN}$(msg "configure_current" "$current_lang_name")${NC}"
        echo ""
    fi
    
    echo -e "${CYAN}$(msg "configure_select")${NC}"
    echo -e "$(msg "configure_korean")"
    echo -e "$(msg "configure_english")"
    echo ""
    
    while true; do
        read -p "$(msg "configure_prompt")" choice
        case $choice in
            1)
                LANGUAGE="ko"
                save_config "ko"
                echo -e "${GREEN}$(msg "configure_success" "í•œêµ­ì–´")${NC}"
                break
                ;;
            2)
                LANGUAGE="en"
                save_config "en"
                echo -e "${GREEN}$(msg "configure_success" "English")${NC}"
                break
                ;;
            *)
                echo -e "${RED}$(msg "configure_invalid")${NC}"
                ;;
        esac
    done
}

# ìµœì´ˆ ì‹¤í–‰ ì²´í¬ ë° ì–¸ì–´ ì„¤ì •
first_time_setup() {
    # í•­ìƒ ì˜ì–´ë¡œ ì‹œì‘ (ë‹¤êµ­ì–´ ì§€ì›ì„ ìœ„í•´)
    echo -e "${MAGENTA}ğŸ‰ Welcome to AI Commit Assistant!${NC}"
    echo -e "${BLUE}============================================================${NC}"
    echo -e "${BOLD}First-time setup${NC}"
    echo -e "${BLUE}============================================================${NC}"
    echo ""
    echo -e "${CYAN}Please select your preferred language for UI and commit messages:${NC}"
    echo ""
    
    echo -e "  1. í•œêµ­ì–´ (Korean)"
    echo -e "  2. English"
    echo ""
    
    while true; do
        read -p "Select (1-2): " choice
        case $choice in
            1)
                LANGUAGE="ko"
                save_config "ko"
                echo ""
                echo -e "${GREEN}âœ… ì–¸ì–´ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: í•œêµ­ì–´${NC}"
                echo ""
                break
                ;;
            2)
                LANGUAGE="en"
                save_config "en"
                echo ""
                echo -e "${GREEN}âœ… Language set to: English${NC}"
                echo ""
                break
                ;;
            *)
                echo -e "${RED}âŒ Invalid choice. Please select 1 or 2.${NC}"
                ;;
        esac
    done
}

# ì„¤ì • ë¡œë“œ
load_config

# í”Œë˜ê·¸ ë³€ìˆ˜ ì´ˆê¸°í™”
STAGE_ALL=false

# ì¸ì ì²˜ë¦¬
while [[ $# -gt 0 ]]; do
    case $1 in
        --setup)
            # ì„¤ì •ì´ ì—†ìœ¼ë©´ ë¨¼ì € ì–¸ì–´ ì„¤ì •
            if [ -z "$LANGUAGE" ]; then
                first_time_setup
            fi
            
            echo -e "${CYAN}$(msg "setup_progress")${NC}"
            
            # git aic alias ì„¤ì •
            git config --global alias.aic '!aic'
            
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}$(msg "setup_success")${NC}"
                echo -e "${CYAN}$(msg "setup_available")${NC}"
                echo "  - aic"
                echo "  - ai-commit"
                echo "  - git aic"
            else
                echo -e "${RED}$(msg "setup_failed")${NC}"
                exit 1
            fi
            exit 0
            ;;
        --unsetup)
            # ì„¤ì •ì´ ì—†ìœ¼ë©´ ë¨¼ì € ì–¸ì–´ ì„¤ì •
            if [ -z "$LANGUAGE" ]; then
                first_time_setup
            fi
            
            echo -e "${CYAN}$(msg "unsetup_progress")${NC}"
            
            # git aic alias í•´ì œ
            git config --global --unset alias.aic
            
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}$(msg "unsetup_success")${NC}"
                echo -e "${CYAN}$(msg "unsetup_available")${NC}"
                echo "  - aic"
                echo "  - ai-commit"
                echo ""
                echo -e "${CYAN}$(msg "unsetup_help")${NC}"
                echo "  aic --setup"
            else
                echo -e "${RED}$(msg "unsetup_failed")${NC}"
                echo -e "${CYAN}$(msg "unsetup_not_found")${NC}"
                exit 1
            fi
            exit 0
            ;;
        --configure)
            # ì„¤ì •ì´ ì—†ìœ¼ë©´ ë¨¼ì € ì–¸ì–´ ì„¤ì •
            if [ -z "$LANGUAGE" ]; then
                first_time_setup
            else
                configure_language
            fi
            exit 0
            ;;
        --all|-a)
            STAGE_ALL=true
            shift
            ;;
        --help|-h)
            # ì„¤ì •ì´ ì—†ìœ¼ë©´ ë¨¼ì € ì–¸ì–´ ì„¤ì •
            if [ -z "$LANGUAGE" ]; then
                first_time_setup
            fi
            
            echo -e "${BOLD}$(msg "welcome")${NC}"
            echo ""
            echo -e "${CYAN}$(msg "help_usage")${NC}"
            echo -e "$(msg "help_staged")"
            echo -e "$(msg "help_all")"
            echo -e "$(msg "help_short_cmd")"
            echo -e "$(msg "help_git_alias")"
            echo ""
            echo -e "${CYAN}$(msg "help_options")${NC}"
            echo -e "$(msg "help_all_desc")"
            echo -e "$(msg "help_configure_desc")"
            echo -e "$(msg "help_setup_desc")"
            echo -e "$(msg "help_unsetup_desc")"
            echo -e "$(msg "help_help_desc")"
            echo ""
            echo -e "${CYAN}$(msg "help_settings")${NC}"
            echo -e "$(msg "help_setup_cmd")"
            echo -e "$(msg "help_unsetup_cmd")"
            echo -e "$(msg "help_configure_cmd")"
            echo ""
            echo -e "${CYAN}$(msg "help_example")${NC}"
            echo "  git add file1.js file2.js"
            echo -e "$(msg "help_example_staged")"
            echo ""
            echo -e "$(msg "help_example_all")"
            echo ""
            exit 0
            ;;
        *)
            echo -e "${RED}$(msg "unknown_option") $1${NC}"
            echo -e "$(msg "usage_help")"
            exit 1
            ;;
    esac
done

# ìƒ‰ìƒ ì •ì˜ (first_time_setupë³´ë‹¤ ë¨¼ì € ì •ì˜)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# ìµœì´ˆ ì‹¤í–‰ ì²´í¬
if [ -z "$LANGUAGE" ]; then
    first_time_setup
fi

# ë¸Œë¼ì¼ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
show_braille() {
    local pid=$1
    local delay=0.08
    local braille="â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â "
    local i=0
    
    while kill -0 "$pid" 2>/dev/null; do
        printf "\r${CYAN}$(msg "ai_generating") ${braille:$i:1}${NC}"
        i=$(((i+1) % ${#braille}))
        sleep $delay
    done
    printf "\r${CYAN}$(msg "ai_generating") âœ“${NC}\n"
}

echo -e "${MAGENTA}$(msg "welcome")${NC}"

# Git ì €ì¥ì†Œ í™•ì¸
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo -e "${RED}$(msg "not_git_repo")${NC}"
    exit 1
fi

# --all í”Œë˜ê·¸ê°€ ìˆìœ¼ë©´ ëª¨ë“  íŒŒì¼ì„ staging
if [ "$STAGE_ALL" = true ]; then
    echo -e "${CYAN}$(msg "staging_all")${NC}"
    git add .
fi

# Gemini CLI ì„¤ì¹˜ í™•ì¸
if ! command -v gemini >/dev/null 2>&1; then
    echo -e "${YELLOW}$(msg "gemini_not_installed")${NC}"
    echo ""
    
    # ì‚¬ìš©ìì—ê²Œ ì„ íƒ ë¬¼ì–´ë³´ê¸°
    while true; do
        read -p "$(msg "editor_prompt")" choice
        case $choice in
            [Yy]|[Yy]es|[ì˜ˆ]|[ë„¤])
                echo -e "${CYAN}$(msg "fallback_editor")${NC}"
                echo ""
                # ì¼ë°˜ git commitì²˜ëŸ¼ ë™ì‘
                git commit
                exit $?
                ;;
            [Nn]|[Nn]o|[ì•„ë‹ˆì˜¤]|[ì•ˆë¨])
                echo -e "${CYAN}$(msg "editor_cancelled")${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}$(msg "editor_invalid")${NC}"
                ;;
        esac
    done
fi

# ë³€ê²½ì‚¬í•­ í™•ì¸
STAGED_DIFF=$(git diff --cached 2>/dev/null)
UNSTAGED_DIFF=$(git diff 2>/dev/null)
STATUS=$(git status --porcelain 2>/dev/null)

# staged íŒŒì¼ë§Œ í•„í„°ë§ (--all í”Œë˜ê·¸ê°€ ì—†ì„ ë•Œ)
if [ "$STAGE_ALL" = false ]; then
    STAGED_STATUS=$(echo "$STATUS" | grep '^[AMDRC]')
else
    STAGED_STATUS="$STATUS"
fi

# staged íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
if [ -z "$STAGED_DIFF" ]; then
    echo -e "${YELLOW}$(msg "no_staged_files")${NC}"
    echo ""
    echo -e "${CYAN}$(msg "choose_action")${NC}"
    echo -e "$(msg "action_1")"
    echo -e "$(msg "action_2")"
    echo -e "$(msg "action_3")"
    echo ""
    
    if [ -n "$UNSTAGED_DIFF" ]; then
        echo -e "${CYAN}$(msg "unstaged_files")${NC}"
        git status --short | head -10
        if [ $(git status --short | wc -l) -gt 10 ]; then
            echo -e "${YELLOW}... ê·¸ë¦¬ê³  $(expr $(git status --short | wc -l) - 10)ê°œ íŒŒì¼ ë”${NC}"
        fi
    else
        echo -e "${CYAN}$(msg "no_changes")${NC}"
    fi
    exit 1
fi

DIFF="$STAGED_DIFF"
echo -e "${CYAN}$(msg "analyzing_staged")${NC}"

# ë³€ê²½ì‚¬í•­ ë¶„ì„
ANALYSIS_TEXT="$DIFF"

# ì–¸ì–´ë³„ Gemini í”„ë¡¬í”„íŠ¸ ìƒì„±
if [ "$LANGUAGE" = "en" ]; then
    DETAILED_MULTILINE_PROMPT="You are a git commit message generator. Analyze these git changes and generate a detailed multiline commit message.

ANALYZE THE CHANGES CAREFULLY:
- Look at file extensions and diff content to understand what changed
- Identify if changes are: code improvements, style/formatting, documentation, features, or cleanup
- Pay attention to deleted files, formatting changes, whitespace fixes

GENERATE MESSAGE IN THIS FORMAT:

TITLE (50 chars max):
- Start with: feat: (new features), refactor: (code improvement), style: (formatting), docs: (documentation), chore: (cleanup/maintenance)
- Brief summary in English

BODY (after TWO blank lines):
- filename: specific description of changes
- IMPORTANT: TWO blank lines between each file
- Use English language

Git Status:
$STAGED_STATUS

Changes Analysis:
$(echo "$ANALYSIS_TEXT" | head -20)

EXACT FORMAT REQUIRED (copy this structure):

feat: Implement user authentication system and loading components


src/utils/auth.ts: JWT token validation and user permission management


src/components/LoadingSpinner.vue: Improved user experience during async operations

CRITICAL: Use exactly TWO newlines between title and body, and TWO newlines between each file.
Keep descriptions under 80 characters.
Generate ONLY the commit message, no quotes:"
else
    DETAILED_MULTILINE_PROMPT="You are a git commit message generator. Analyze these git changes and generate a detailed multiline commit message.

ANALYZE THE CHANGES CAREFULLY:
- Look at file extensions and diff content to understand what changed
- Identify if changes are: code improvements, style/formatting, documentation, features, or cleanup
- Pay attention to deleted files, formatting changes, whitespace fixes

GENERATE MESSAGE IN THIS FORMAT:

TITLE (50 chars max):
- Start with: feat: (new features), refactor: (code improvement), style: (formatting), docs: (documentation), chore: (cleanup/maintenance)
- Brief summary in Korean

BODY (after TWO blank lines):
- filename: specific description of changes
- IMPORTANT: TWO blank lines between each file
- Use Korean language

Git Status:
$STAGED_STATUS

Changes Analysis:
$(echo "$ANALYSIS_TEXT" | head -20)

EXACT FORMAT REQUIRED (copy this structure):

feat: ì‚¬ìš©ì ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ ë° ë¡œë”© ì»´í¬ë„ŒíŠ¸ ì¶”ê°€


src/utils/auth.ts: JWT í† í° ê²€ì¦ ë° ì‚¬ìš©ì ê¶Œí•œ ê´€ë¦¬ ê¸°ëŠ¥ êµ¬í˜„


src/components/LoadingSpinner.vue: ë¹„ë™ê¸° ì‘ì—… ì¤‘ ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

CRITICAL: Use exactly TWO newlines between title and body, and TWO newlines between each file.
Keep descriptions under 80 characters.
Generate ONLY the commit message, no quotes:"
fi

# Gemini CLI í˜¸ì¶œ ì‹œë„
AI_MESSAGE=""

if [ -z "$AI_MESSAGE" ]; then
    # ë°±ê·¸ë¼ìš´ë“œì—ì„œ Gemini CLI ì‹¤í–‰
    TEMP_OUTPUT="/tmp/gemini_output_$$"
    (gemini --model gemini-2.5-flash --prompt "$DETAILED_MULTILINE_PROMPT" 2>&1 > "$TEMP_OUTPUT"; echo $? > "/tmp/gemini_exit_$$") &
    GEMINI_PID=$!
    
    # ë¸Œë¼ì¼ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    show_braille $GEMINI_PID
    
    # í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ ëŒ€ê¸°
    wait $GEMINI_PID
    
    # ê²°ê³¼ ì½ê¸°
    GEMINI_OUTPUT=$(cat "$TEMP_OUTPUT")
    GEMINI_EXIT_CODE=$(cat "/tmp/gemini_exit_$$")
    
    # ì„ì‹œ íŒŒì¼ ì •ë¦¬
    rm -f "$TEMP_OUTPUT" "/tmp/gemini_exit_$$"
    
    # Gemini CLI ì‹¤í–‰ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
    if [ $GEMINI_EXIT_CODE -ne 0 ]; then
        echo -e "${YELLOW}$(msg "gemini_not_installed")${NC}"
        echo ""
        
        # ì‚¬ìš©ìì—ê²Œ ì„ íƒ ë¬¼ì–´ë³´ê¸°
        while true; do
            read -p "$(msg "editor_prompt")" choice
            case $choice in
                [Yy]|[Yy]es|[ì˜ˆ]|[ë„¤])
                    echo -e "${CYAN}$(msg "fallback_editor")${NC}"
                    echo ""
                    # ì¼ë°˜ git commitì²˜ëŸ¼ ë™ì‘
                    git commit
                    exit $?
                    ;;
                [Nn]|[Nn]o|[ì•„ë‹ˆì˜¤]|[ì•ˆë¨])
                    echo -e "${CYAN}$(msg "editor_cancelled")${NC}"
                    exit 0
                    ;;
                *)
                    echo -e "${RED}$(msg "editor_invalid")${NC}"
                    ;;
            esac
        done
    else
        # "Loaded cached credentials." ì œê±°í•˜ê³  ì˜ë¯¸ìˆëŠ” ì¶œë ¥ ì¶”ì¶œ
        AI_MESSAGE=$(echo "$GEMINI_OUTPUT" | grep -v "Loaded cached credentials" | grep -v "^$" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
        
        # ê¸¸ì´ ì²´í¬ (ìµœì†Œ 30ì ì´ìƒì´ì–´ì•¼ í•¨)
        MSG_LENGTH=${#AI_MESSAGE}
        if [ "$MSG_LENGTH" -lt 30 ]; then
            echo -e "${YELLOW}âš ï¸  Message too short: $MSG_LENGTH chars. Trying simplified approach...${NC}"
            
            # ì–¸ì–´ë³„ ë‹¨ìˆœ í”„ë¡¬í”„íŠ¸
            if [ "$LANGUAGE" = "en" ]; then
                SIMPLE_PROMPT="Generate a detailed English commit message with title and body for: $(echo "$STAGED_STATUS" | head -3 | tr '\n' ' ')"
            else
                SIMPLE_PROMPT="Generate a detailed Korean commit message with title and body for: $(echo "$STAGED_STATUS" | head -3 | tr '\n' ' ')"
            fi
            
            # ë‹¨ìˆœ ì ‘ê·¼ë²•ë„ ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜
            TEMP_OUTPUT2="/tmp/gemini_simple_$$"
            (gemini --model gemini-2.5-flash --prompt "$SIMPLE_PROMPT" 2>&1 > "$TEMP_OUTPUT2"; echo $? > "/tmp/gemini_simple_exit_$$") &
            SIMPLE_PID=$!
            
            # ë¸Œë¼ì¼ ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ì¬ì‹œë„
            show_braille $SIMPLE_PID
            wait $SIMPLE_PID
            
            SIMPLE_OUTPUT=$(cat "$TEMP_OUTPUT2")
            SIMPLE_EXIT_CODE=$(cat "/tmp/gemini_simple_exit_$$")
            rm -f "$TEMP_OUTPUT2" "/tmp/gemini_simple_exit_$$"
            
            if [ $SIMPLE_EXIT_CODE -eq 0 ]; then
                AI_MESSAGE=$(echo "$SIMPLE_OUTPUT" | grep -v "Loaded cached credentials" | grep -v "^$" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            else
                echo -e "${YELLOW}âš ï¸  Simplified approach also failed. Using editor...${NC}"
                
                # ì¼ë°˜ git commitì²˜ëŸ¼ ë™ì‘
                git commit
                exit $?
            fi
        fi
    fi
fi

# AI ì‘ë‹µ ì²˜ë¦¬
if [ -n "$AI_MESSAGE" ] && [ "$AI_MESSAGE" != "Loaded cached credentials." ]; then
    # ë¶ˆí•„ìš”í•œ í…ìŠ¤íŠ¸ ì œê±°
    AI_MESSAGE=$(echo "$AI_MESSAGE" | sed 's/^["'\'']\|["'\'']$//g' | sed 's/^\*\s*//' | sed 's/^-\s*//')
    
    # ë©”ì‹œì§€ í˜•ì‹ í›„ì²˜ë¦¬ - ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    AI_MESSAGE=$(echo "$AI_MESSAGE" | awk '
    BEGIN { 
        title_done = 0; 
        body_started = 0;
        first_file = 1;
    }
    /^[a-z]+:/ { 
        if (!title_done) {
            print $0;
            print "";
            print "";
            title_done = 1;
            next;
        }
    }
    /\.(ts|js|vue|md|json|sh):/ {
        if (body_started && !first_file) {
            print "";
            print "";
        }
        print $0;
        body_started = 1;
        first_file = 0;
        next;
    }
    {
        if (title_done && $0 != "") {
            if (!body_started && !match($0, /\.(ts|js|vue|md|json|sh):/)) {
                print "";
                print "";
                body_started = 1;
            }
            if (match($0, /\.(ts|js|vue|md|json|sh):/)) {
                if (!first_file) {
                    print "";
                    print "";
                }
                first_file = 0;
            }
            print $0;
        }
    }')
    
    echo ""
    echo -e "${BLUE}============================================================${NC}"
    echo -e "${GREEN}$(msg "ai_generated")${NC}"
    echo -e "${BOLD}\"$AI_MESSAGE\"${NC}"
    echo -e "${BLUE}============================================================${NC}"
else
    echo -e "${YELLOW}$(msg "ai_no_response")${NC}"
    echo -e "${CYAN}$(msg "fallback_editor")${NC}"
    echo ""
    
    # ì¼ë°˜ git commitì²˜ëŸ¼ ë™ì‘
    git commit
    exit $?
fi

# ë³€ê²½ì‚¬í•­ ìš”ì•½ ì¶œë ¥
echo ""
echo -e "${CYAN}$(msg "change_summary")${NC}"
# STAGE_ALL í”Œë˜ê·¸ì— ë”°ë¼ íŒŒì¼ ì¹´ìš´íŠ¸ ê³„ì‚°
if [ "$STAGE_ALL" = false ]; then
    ADDED_FILES=$(echo "$STAGED_STATUS" | grep "^A" | wc -l)
    MODIFIED_FILES=$(echo "$STAGED_STATUS" | grep "^M" | wc -l)
    DELETED_FILES=$(echo "$STAGED_STATUS" | grep "^D" | wc -l)
else
    ADDED_FILES=$(echo "$STATUS" | grep "^??\|^A" | wc -l)
    MODIFIED_FILES=$(echo "$STATUS" | grep "^.M\|^M" | wc -l)
    DELETED_FILES=$(echo "$STATUS" | grep "^.D\|^D" | wc -l)
fi

[ "$ADDED_FILES" -gt 0 ] && echo -e "  ${GREEN}$(msg "new_files" "$ADDED_FILES")${NC}"
[ "$MODIFIED_FILES" -gt 0 ] && echo -e "  ${YELLOW}$(msg "modified_files" "$MODIFIED_FILES")${NC}"
[ "$DELETED_FILES" -gt 0 ] && echo -e "  ${RED}$(msg "deleted_files" "$DELETED_FILES")${NC}"
echo ""

while true; do
    read -p "$(echo -e "${BOLD}$(msg "commit_prompt")${NC} ")" choice
    case $choice in
        [Yy]* )
            if git commit -m "$AI_MESSAGE"; then
                echo -e "${GREEN}$(msg "commit_success")${NC}"
            else
                echo -e "${RED}$(msg "commit_failed")${NC}"
            fi
            break
            ;;
        [Nn]* )
            echo -e "${YELLOW}$(msg "commit_cancelled")${NC}"
            exit 0
            ;;
        [Ee]* )
            TEMP_FILE="/tmp/edit_commit_$$.txt"
            echo "$AI_MESSAGE" > "$TEMP_FILE"
            echo -e "${CYAN}$(msg "editor_starting")${NC}"
            ${EDITOR:-vi} "$TEMP_FILE"
            EDITED_MESSAGE=$(cat "$TEMP_FILE" | head -1 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            rm -f "$TEMP_FILE"
            
            if [ -n "$EDITED_MESSAGE" ]; then
                if git commit -m "$EDITED_MESSAGE"; then
                    echo -e "${GREEN}$(msg "edit_success")${NC}"
                else
                    echo -e "${RED}$(msg "commit_failed")${NC}"
                fi
            else
                echo -e "${YELLOW}$(msg "edit_cancelled")${NC}"
            fi
            break
            ;;
        [Cc]* )
            read -p "$(echo -e "${CYAN}$(msg "custom_message")${NC} ")" CUSTOM_MESSAGE
            if [ -n "$CUSTOM_MESSAGE" ]; then
                if git commit -m "$CUSTOM_MESSAGE"; then
                    echo -e "${GREEN}$(msg "custom_success")${NC}"
                else
                    echo -e "${RED}$(msg "commit_failed")${NC}"
                fi
            else
                echo -e "${YELLOW}$(msg "empty_message")${NC}"
            fi
            break
            ;;
        * )
            echo -e "${RED}$(msg "invalid_choice")${NC}"
            ;;
    esac
done
